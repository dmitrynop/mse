#!/bin/bash

set -e

source ./bin/utils/set-env

TAG=$MSE_VERSION

if [ "$TAG" == "" ]; then
  echo "No tag given"
  exit
fi

# this cannot be set, otherwise docker would use the remote machine to build
unset DOCKER_HOST
unset DOCKER_CERT_PATH
unset DOCKER_TLS_VERIFY

mix docker.build
mix docker.release
mix docker.publish --tag $TAG

git tag $TAG
git push --tags &

./bin/prod build
./bin/prod stop web
./bin/prod up -d
