#!/bin/bash

set -e

source ./bin/utils/set-env

TAG=$MTGSEARCH_VERSION

if [ "$TAG" == "" ]; then
  echo "No tag given"
  exit
fi

# this cannot be set, otherwise docker would use the remote machine to build
unset DOCKER_HOST

# build docker release
docker build -f Dockerfile.build -t naps62/mtgsearch:release .
docker tag naps62/mtgsearch:release naps62/mtgsearch:$MTGSEARCH_VERSION
docker push naps62/mtgsearch:$MTGSEARCH_VERSION --force

git tag --force $TAG
git push --tags &

./bin/prod pull
./bin/prod stop web
./bin/prod up -d
