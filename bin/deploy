#!/bin/bash

set -e

source ./bin/utils/set-env

TAG=$MSE_VERSION

if [ "$TAG" == "" ]; then
  echo "No tag given"
  exit
fi

# this cannot be set, otherwise docker would use the remote machine to build
unset DOCKER_HOST
unset DOCKER_CERT_PATH
unset DOCKER_TLS_VERIFY

# build docker release
docker build -f Dockerfile.build -t naps62/mse:release .
docker tag naps62/mse:release naps62/mse:$MSE_VERSION
docker push naps62/mse:$MSE_VERSION

git tag --force $TAG
git push --tags &

./bin/prod pull
./bin/prod stop web
./bin/prod up -d
